<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Single Car Model — Loan APR + Equity Returns</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#101a2e;
      --panel2:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#26344f;
      --accent:#60a5fa;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#f87171;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    html,body{height:100%;}
    body{
      margin:0;
      font-family: var(--sans);
      background: radial-gradient(1200px 600px at 20% 0%, #142347 0%, var(--bg) 60%);
      color: var(--text);
    }
    .wrap{
      max-width: 1400px;
      margin: 22px auto;
      padding: 0 16px 36px;
    }

    /* Top KPI box */
    .hero{
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 16px 16px 14px;
      background: linear-gradient(180deg, rgba(96,165,250,0.18), rgba(0,0,0,0.18));
      box-shadow: 0 16px 34px rgba(0,0,0,0.28);
      margin-bottom: 14px;
    }
    .heroTop{
      display:flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .hero h1{
      margin:0;
      font-size: 18px;
      font-weight: 750;
      letter-spacing: 0.2px;
    }
    .hero .sub{
      margin:0;
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.35;
    }
    .kpiGrid{
      display:grid;
      grid-template-columns: repeat(7, minmax(150px, 1fr));
      gap: 10px;
    }
    @media (max-width: 1200px){
      .kpiGrid{ grid-template-columns: repeat(3, minmax(160px, 1fr)); }
    }
    @media (max-width: 720px){
      .kpiGrid{ grid-template-columns: repeat(2, minmax(160px, 1fr)); }
    }
    .kpi{
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(38,52,79,0.9);
      border-radius: 14px;
      padding: 10px 10px 9px;
      min-height: 62px;
    }
    .kpi .name{
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 6px;
    }
    .kpi .val{
      font-family: var(--mono);
      font-size: 14px;
      color: #eaf2ff;
      line-height: 1.2;
      white-space: pre-wrap;
    }

    /* Inputs bar */
    .inputsCard{
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 14px 14px 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      box-shadow: 0 12px 28px rgba(0,0,0,0.25);
      margin-bottom: 14px;
    }
    .inputsHeader{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .inputsHeader h2{
      margin:0;
      font-size: 13.5px;
      font-weight: 750;
      color: #eaf2ff;
    }
    .actions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }
    button{
      appearance:none;
      border: 1px solid #355085;
      background: linear-gradient(180deg, rgba(96,165,250,0.28), rgba(96,165,250,0.12));
      color: #eaf2ff;
      padding: 8px 11px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 700;
      letter-spacing: 0.2px;
      font-size: 12.5px;
    }
    button:hover{ filter: brightness(1.05); }
    button.secondary{
      background: rgba(0,0,0,0.16);
      border-color: var(--border);
      color: var(--text);
      font-weight: 650;
    }

    .inputsRow{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: stretch;
    }
    .field{
      flex: 1 1 220px;
      min-width: 220px;
      background: rgba(0,0,0,0.18);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px 10px 9px;
    }
    .label{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .label span.small{
      font-family: var(--mono);
      font-size: 11px;
      color: #b6c2d6;
      opacity: 0.9;
    }
    input[type="text"], input[type="number"], select{
      width:100%;
      box-sizing:border-box;
      border-radius: 12px;
      border: 1px solid #314369;
      background: #0b1428;
      color: var(--text);
      padding: 9px 10px;
      font-size: 13.5px;
      outline:none;
    }
    input[type="text"]:focus, input[type="number"]:focus, select:focus{
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(96,165,250,0.18);
    }
    .toggle{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .toggle label{
      display:flex;
      gap: 7px;
      align-items:center;
      font-size: 12px;
      color: var(--muted);
      user-select:none;
    }
    .toggle input{ accent-color: var(--accent); }

    /* Slider styling */
    .sliderRow{
      display:flex;
      gap: 10px;
      align-items:center;
      margin-top: 6px;
    }
    input[type="range"]{
      width: 100%;
      accent-color: var(--accent);
    }
    .rangeVal{
      font-family: var(--mono);
      font-size: 12px;
      color: #eaf2ff;
      min-width: 64px;
      text-align: right;
    }
    .ticks{
      display:flex;
      justify-content: space-between;
      gap: 6px;
      margin-top: 4px;
      font-size: 10px;
      color: #93a4c1;
      font-family: var(--mono);
      opacity: 0.9;
    }

    /* Table card */
    .tableCard{
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      box-shadow: 0 12px 28px rgba(0,0,0,0.25);
    }
    .tableHeader{
      display:flex;
      justify-content: space-between;
      align-items: baseline;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }
    .tableHeader h2{
      margin:0;
      font-size: 13.5px;
      font-weight: 750;
      color: #eaf2ff;
    }
    .tableHeader .hint{
      margin:0;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }

    .tableWrap{
      overflow:auto;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.16);
    }
    table{
      width:100%;
      border-collapse: collapse;
      min-width: 1020px;
      font-size: 12px;
    }
    th, td{
      border-bottom: 1px solid rgba(38,52,79,0.75);
      padding: 9px 8px;
      text-align: right;
      white-space: nowrap;
    }
    th{
      position: sticky;
      top: 0;
      background: #0b1428;
      z-index: 1;
      font-weight: 800;
      color: #eaf2ff;
      border-bottom: 1px solid #334766;
    }
    th.left, td.left{
      text-align: left;
      position: sticky;
      left: 0;
      background: #0b1428;
      z-index: 2;
    }
    th.left2, td.left2{
      text-align: left;
      position: sticky;
      left: 120px;
      background: #0b1428;
      z-index: 2;
    }
    th.left, td.left{ min-width: 120px; max-width: 120px; }
    th.left2, td.left2{ min-width: 320px; max-width: 320px; }

    tr:last-child td{ border-bottom: none; }

    .muted{ color: var(--muted); }
    .cap{ color: #dbeafe; }
    .fee{ color: #fde68a; }
    .net{ color: #eaf2ff; font-weight: 800; }
    .neg{ color: #fecaca; }
    .pos{ color: #bbf7d0; }
    .bal{ color: #c7d2fe; font-weight: 700; }

    .below{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.45;
    }
    .below strong{
      color: #eaf2ff;
      font-weight: 800;
    }
    .pill{
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 11px;
      color: #c7d2fe;
      background: rgba(0,0,0,0.18);
      font-family: var(--mono);
      margin-left: 6px;
    }
    .inlineNote{
      margin-top: 6px;
      color: #93a4c1;
      font-size: 11px;
      line-height: 1.25;
      font-family: var(--mono);
      opacity: 0.95;
    }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- KPI / summary box -->
    <div class="hero">
      <div class="heroTop">
        <h1>Single Car Model <span class="pill">Loan APR vs Equity Returns</span></h1>
        <p class="sub">
          Loan IRR/APR excludes sale proceeds. Equity MOIC/IRR uses sale price and treats fees + curtailments as equity cash out.
        </p>
      </div>
      <div class="kpiGrid">
        <div class="kpi">
          <div class="name">Purchase Price (Invoice)</div>
          <div class="val" id="kpiInvoice">—</div>
        </div>
        <div class="kpi">
          <div class="name">Advance Amount</div>
          <div class="val" id="kpiAdvance">—</div>
        </div>
        <div class="kpi">
          <div class="name">Sale Price</div>
          <div class="val" id="kpiSalePrice">—</div>
        </div>
        <div class="kpi">
          <div class="name">Monthly Rate (Loan IRR)</div>
          <div class="val" id="kpiLoanIrrMo">—</div>
        </div>
        <div class="kpi">
          <div class="name">APR (Loan)</div>
          <div class="val" id="kpiLoanApr">—</div>
        </div>
        <div class="kpi">
          <div class="name">Absolute Return</div>
          <div class="val" id="kpiAbsReturn">—</div>
        </div>
        <div class="kpi">
          <div class="name">Return on Equity</div>
          <div class="val" id="kpiRoe">—</div>
        </div>
      </div>
    </div>

    <!-- Inputs -->
    <div class="inputsCard">
      <div class="inputsHeader">
        <h2>Inputs</h2>
        <div class="actions">
          <button id="recalc">Recalculate</button>
          <button class="secondary" id="reset">Reset defaults</button>
        </div>
      </div>

      <div class="inputsRow">
        <!-- Invoice -->
        <div class="field">
          <div class="label">
            <span>Invoice Value (Purchase Price)</span>
            <span class="small">£</span>
          </div>
          <!-- text input so we can show commas -->
          <input id="invoice" type="text" inputmode="numeric" value="1,000,000" />
          <div class="inlineNote">Commas shown on blur.</div>
        </div>

        <!-- Sale Price -->
        <div class="field">
          <div class="label">
            <span>Sale Price</span>
            <span class="small">£ (defaults +10%)</span>
          </div>
          <input id="salePrice" type="text" inputmode="numeric" value="1,100,000" />
          <div class="inlineNote">Auto-updates with invoice until overridden.</div>
        </div>

        <!-- Advance slider -->
        <div class="field">
          <div class="label">
            <span>Advance Rate (slider)</span>
            <span class="small">%</span>
          </div>
          <div class="sliderRow">
            <input id="advanceSlider" type="range" min="0" max="8" step="1" value="8" />
            <div class="rangeVal" id="advancePctLabel">80%</div>
          </div>
          <div class="ticks" id="advanceTicks"></div>
          <div class="inlineNote">Steps: 40,45,50,55,60,65,70,75,80.</div>
        </div>

        <!-- Sale Month -->
        <div class="field">
          <div class="label">
            <span>Sale Month</span>
            <span class="small">M1…MN</span>
          </div>
          <input id="saleMonth" type="number" min="1" step="1" value="12" />
        </div>

        <!-- Processing Fee -->
        <div class="field">
          <div class="label">
            <span>Processing Fee (M0)</span>
            <span class="small">£</span>
          </div>
          <input id="procFee" type="text" inputmode="numeric" value="250" />
          <div class="inlineNote">Included in fees.</div>
        </div>

        <!-- Unit fee: schedule + override -->
        <div class="field">
          <div class="label">
            <span>Monthly Unit Fee</span>
            <span class="small">%/mo</span>
          </div>

          <div class="toggle" aria-label="Unit fee schedule vs override">
            <label><input type="checkbox" id="useSchedule" checked /> Use schedule (based on advance rate)</label>
          </div>

          <input id="unitFeePct" type="number" min="0" step="0.01" value="0.63" />

          <div class="toggle" aria-label="Unit fee base">
            <label><input type="radio" name="unitBase" value="invoice" checked /> charge on Invoice</label>
            <label><input type="radio" name="unitBase" value="advance" /> charge on Advance</label>
          </div>

          <div class="inlineNote" id="scheduleNote">
            Schedule: 80→0.63, 75→0.59, 70→0.55, 65→0.51, 60→0.47, 55→0.43, 50→0.39, 45→0.35, 40→0.31
          </div>
        </div>

        <!-- Capital repayment -->
        <div class="field">
          <div class="label">
            <span>Capital Repayment @ M6 (Day 180)</span>
            <span class="small">% + base</span>
          </div>
          <input id="capRepPct" type="number" min="0" step="0.1" value="10" />
          <div class="toggle" aria-label="Capital repayment base">
            <label><input type="radio" name="capBase" value="invoice" checked /> % of Invoice</label>
            <label><input type="radio" name="capBase" value="outstanding" /> % of Outstanding</label>
          </div>
        </div>

        <!-- Additional curtailment -->
        <div class="field">
          <div class="label">
            <span>Additional Curtailment (Optional)</span>
            <span class="small">% + month</span>
          </div>
          <input id="addCurtPct" type="number" min="0" step="0.1" value="0" />
          <div style="margin-top:8px;">
            <select id="addCurtMonth" aria-label="Additional curtailment month"></select>
          </div>
          <div class="label" style="margin-top:8px;">
            <span class="muted">Base matches Capital Repayment</span>
            <span class="small" id="addCurtBaseLabel">Invoice</span>
          </div>
        </div>

      </div>
    </div>

    <!-- Table -->
    <div class="tableCard">
      <div class="tableHeader">
        <h2>Loan Cashflows (for Loan IRR/APR)</h2>
        <p class="hint">
          Borrower perspective. Sale price is not included in loan APR.
          Principal balance shown end-of-month after principal payments.
        </p>
      </div>
      <div class="tableWrap" id="tableWrap"></div>

      <div class="below" id="belowBlock"></div>
    </div>

  </div>

<script>
  /* -----------------------------
     Schedule + slider mapping
  ------------------------------*/
  const ADV_STEPS = [40, 45, 50, 55, 60, 65, 70, 75, 80];
  const UNIT_FEE_BY_ADV = {
    80: 0.63,
    75: 0.59,
    70: 0.55,
    65: 0.51,
    60: 0.47,
    55: 0.43,
    50: 0.39,
    45: 0.35,
    40: 0.31
  };

  /* -----------------------------
     State
  ------------------------------*/
  let salePriceTouched = false;

  /* -----------------------------
     Utilities
  ------------------------------*/
  function parseNumberFromText(s){
    if (s == null) return 0;
    const cleaned = String(s).replace(/[^0-9.\-]/g, "");
    const v = Number(cleaned);
    return isFinite(v) ? v : 0;
  }
  function formatIntWithCommas(n){
    const v = Math.round(Number(n));
    if (!isFinite(v)) return "";
    return v.toLocaleString(undefined, {maximumFractionDigits: 0});
  }
  function gbp(x){
    const sign = x < 0 ? "-" : "";
    const v = Math.abs(x);
    return sign + "£" + v.toLocaleString(undefined, {maximumFractionDigits: 2, minimumFractionDigits: 0});
  }
  function pct(x, decimals=2){
    if (!isFinite(x)) return "—";
    return (x*100).toFixed(decimals) + "%";
  }
  function clampInt(v, min, max){
    v = Math.round(Number(v));
    if (!isFinite(v)) v = min;
    return Math.max(min, Math.min(max, v));
  }
  function getRadio(name){
    const el = document.querySelector(`input[name="${name}"]:checked`);
    return el ? el.value : null;
  }

  /* -----------------------------
     IRR: monthly via bisection
  ------------------------------*/
  function npv(rate, cfs){
    let s = 0;
    for (let t=0; t<cfs.length; t++){
      s += cfs[t] / Math.pow(1+rate, t);
    }
    return s;
  }
  function irrMonthly(cfs){
    let hasPos=false, hasNeg=false;
    for (const x of cfs){
      if (x > 0) hasPos = true;
      if (x < 0) hasNeg = true;
    }
    if (!(hasPos && hasNeg)) return NaN;

    let lo = -0.9999;
    let hi = 5.0;
    let fLo = npv(lo, cfs);
    let fHi = npv(hi, cfs);

    let iter=0;
    while (fLo*fHi > 0 && hi < 100 && iter < 60){
      hi *= 2;
      fHi = npv(hi, cfs);
      iter++;
    }
    if (fLo*fHi > 0) return NaN;

    for (let i=0; i<140; i++){
      const mid = (lo+hi)/2;
      const fMid = npv(mid, cfs);
      if (Math.abs(fMid) < 1e-9) return mid;
      if (fLo*fMid <= 0){
        hi = mid; fHi = fMid;
      }else{
        lo = mid; fLo = fMid;
      }
    }
    return (lo+hi)/2;
  }

  /* -----------------------------
     Month dropdown
  ------------------------------*/
  function populateCurtailmentMonthDropdown(){
    const sel = document.getElementById("addCurtMonth");
    const saleMonth = clampInt(document.getElementById("saleMonth").value, 1, 120);
    const current = Number(sel.value) || 6;

    sel.innerHTML = "";
    const maxM = Math.max(12, saleMonth);
    for (let m=1; m<=maxM; m++){
      const opt = document.createElement("option");
      opt.value = String(m);
      opt.textContent = `Month ${m}`;
      sel.appendChild(opt);
    }
    sel.value = String(Math.min(Math.max(current, 1), maxM));
  }

  /* -----------------------------
     Advance slider helpers
  ------------------------------*/
  function getAdvancePctFromSlider(){
    const idx = clampInt(document.getElementById("advanceSlider").value, 0, ADV_STEPS.length-1);
    return ADV_STEPS[idx];
  }
  function setAdvanceSliderToPct(pct){
    const idx = ADV_STEPS.indexOf(pct);
    document.getElementById("advanceSlider").value = String(idx >= 0 ? idx : (ADV_STEPS.length-1));
  }
  function updateAdvanceLabels(){
    const adv = getAdvancePctFromSlider();
    document.getElementById("advancePctLabel").textContent = adv.toFixed(0) + "%";
  }
  function updateUnitFeeFromScheduleIfEnabled(){
    const use = document.getElementById("useSchedule").checked;
    const unitEl = document.getElementById("unitFeePct");
    if (!use) {
      unitEl.disabled = false;
      return;
    }
    const adv = getAdvancePctFromSlider();
    const fee = UNIT_FEE_BY_ADV[adv];
    unitEl.value = (fee != null) ? fee.toFixed(2) : unitEl.value;
    unitEl.disabled = true;
  }

  /* -----------------------------
     Sale price default (+10%)
  ------------------------------*/
  function maybeUpdateSalePriceFromInvoice(){
    if (salePriceTouched) return;
    const invoice = parseNumberFromText(document.getElementById("invoice").value);
    const suggested = Math.round(invoice * 1.10);
    document.getElementById("salePrice").value = formatIntWithCommas(suggested);
  }

  /* -----------------------------
     Format currency inputs (commas on blur)
  ------------------------------*/
  function attachCommaFormatting(id){
    const el = document.getElementById(id);
    el.addEventListener("blur", ()=>{
      const v = parseNumberFromText(el.value);
      // show commas on blur
      el.value = formatIntWithCommas(v);
    });
    el.addEventListener("focus", ()=>{
      // on focus, keep commas (user can still edit); we don't strip to avoid surprises
    });
  }

  /* -----------------------------
     Model builder
  ------------------------------*/
  function buildModel(){
    const invoice = Math.max(0, parseNumberFromText(document.getElementById("invoice").value));
    const salePrice = Math.max(0, parseNumberFromText(document.getElementById("salePrice").value));

    const advancePct = getAdvancePctFromSlider() / 100;
    const saleMonth = clampInt(document.getElementById("saleMonth").value, 1, 120);

    const procFee = Math.max(0, parseNumberFromText(document.getElementById("procFee").value));

    const unitFeePctMo = Math.max(0, Number(document.getElementById("unitFeePct").value) || 0) / 100;
    const unitBase = getRadio("unitBase"); // invoice|advance

    const capRepPct = Math.max(0, Number(document.getElementById("capRepPct").value) || 0) / 100;
    const capBase = getRadio("capBase"); // invoice|outstanding (shared with additional)

    const addCurtPct = Math.max(0, Number(document.getElementById("addCurtPct").value) || 0) / 100;
    const addCurtMonth = clampInt(document.getElementById("addCurtMonth").value, 1, 120);

    const months = saleMonth;
    const advanceAmt = invoice * advancePct;

    const unitFeeBaseAmt = (unitBase === "advance") ? advanceAmt : invoice;
    const unitFeeMonthly = unitFeeBaseAmt * unitFeePctMo;

    const zeros = () => Array(months+1).fill(0);

    // Loan cashflow lines (borrower view)
    const lineAdvance   = zeros();
    const lineProcFee   = zeros();
    const lineUnitFee   = zeros();
    const lineCapRep    = zeros();
    const lineAddCurt   = zeros();
    const lineFinalPay  = zeros();
    const netLoan       = zeros();

    // Principal balance (end-of-month)
    const principalBal  = Array(months+1).fill(0);

    // Loan: M0
    lineAdvance[0] = advanceAmt;
    lineProcFee[0] = -procFee;

    // Loan: fees M1..M_sale
    for (let m=1; m<=months; m++){
      lineUnitFee[m] = -unitFeeMonthly;
    }

    // Build principal schedule with events in chronological order
    let principal = advanceAmt;

    // event list (month, kind, pct)
    const events = [];
    if (months >= 6 && capRepPct > 0) events.push({m: 6, kind: "cap", pct: capRepPct});
    if (addCurtPct > 0 && addCurtMonth <= months) events.push({m: addCurtMonth, kind: "add", pct: addCurtPct});
    events.sort((a,b)=>a.m-b.m);

    function curtailAmt(pct){
      if (pct <= 0) return 0;
      if (capBase === "invoice") return invoice * pct;
      return principal * pct;
    }

    // Month-by-month walk to record principal balance end-of-month
    let eIdx = 0;
    for (let m=0; m<=months; m++){
      // apply any events that happen at this month (principal paydowns)
      while (eIdx < events.length && events[eIdx].m === m){
        const e = events[eIdx];
        const amt = Math.min(principal, curtailAmt(e.pct));
        if (amt > 0){
          if (e.kind === "cap") lineCapRep[m] += -amt;
          else lineAddCurt[m] += -amt;
          principal -= amt;
        }
        eIdx++;
      }

      // final payoff happens at sale month after any scheduled curtailments that same month
      if (m === months){
        lineFinalPay[m] = -principal;
        principal = 0;
      }

      principalBal[m] = principal; // end-of-month after events and (at sale month) after payoff => 0
    }

    // Net loan cashflow (for loan IRR)
    for (let m=0; m<=months; m++){
      netLoan[m] =
        lineAdvance[m] +
        lineProcFee[m] +
        lineUnitFee[m] +
        lineCapRep[m] +
        lineAddCurt[m] +
        lineFinalPay[m];
    }

    const loanIrrMo = irrMonthly(netLoan);
    const loanApr = isFinite(loanIrrMo) ? (Math.pow(1+loanIrrMo, 12) - 1) : NaN;

    // Fees summary (for absolute return + equity flows)
    const totalUnitFees = unitFeeMonthly * months;
    const totalFees = procFee + totalUnitFees;

    // Absolute return definition (per your instruction)
    const absReturnDollar = salePrice - invoice - totalFees;
    const absReturnPct = (invoice > 0) ? ((salePrice - totalFees)/invoice - 1) : NaN;

    // Equity cashflows (Option A): M0 = -(invoice - advance + procFee)
    // Monthly unit fees and any principal paydowns are equity outflows.
    // Sale month inflow = +salePrice
    const equity = Array(months+1).fill(0);
    equity[0] = -(invoice - advanceAmt) - procFee;
    for (let m=1; m<=months; m++){
      equity[m] += -unitFeeMonthly;
      equity[m] += lineCapRep[m];
      equity[m] += lineAddCurt[m];
      equity[m] += lineFinalPay[m];
    }
    equity[months] += salePrice;

    const equityIrrMo = irrMonthly(equity);
    const equityIrr = isFinite(equityIrrMo) ? (Math.pow(1+equityIrrMo, 12) - 1) : NaN;

    // MOIC = total positive / absolute(total negative)
    let pos=0, neg=0;
    for (const x of equity){
      if (x > 0) pos += x;
      if (x < 0) neg += -x;
    }
    const moic = (neg > 0) ? (pos / neg) : NaN;

    return {
      invoice, salePrice, advancePct, saleMonth: months, procFee,
      unitFeePctMo, unitBase, capRepPct, capBase,
      addCurtPct, addCurtMonth,
      advanceAmt, unitFeeMonthly,
      totalUnitFees, totalFees,
      absReturnDollar, absReturnPct,
      loanIrrMo, loanApr,
      equityIrr, moic,
      lines: { lineAdvance, lineProcFee, lineUnitFee, lineCapRep, lineAddCurt, lineFinalPay, netLoan, principalBal }
    };
  }

  /* -----------------------------
     Render KPIs
  ------------------------------*/
  function renderKpis(m){
    document.getElementById("kpiInvoice").textContent = gbp(m.invoice);
    document.getElementById("kpiAdvance").textContent = gbp(m.advanceAmt);
    document.getElementById("kpiSalePrice").textContent = gbp(m.salePrice);

    document.getElementById("kpiLoanIrrMo").textContent = isFinite(m.loanIrrMo) ? pct(m.loanIrrMo, 3) : "—";
    document.getElementById("kpiLoanApr").textContent   = isFinite(m.loanApr)   ? pct(m.loanApr, 2)   : "—";

    const absStr = `${gbp(m.absReturnDollar)}  |  ${isFinite(m.absReturnPct) ? pct(m.absReturnPct, 2) : "—"}`;
    document.getElementById("kpiAbsReturn").textContent = absStr;

    const roeStr = `${isFinite(m.moic) ? m.moic.toFixed(2) + "x" : "—"}  |  ${isFinite(m.equityIrr) ? pct(m.equityIrr, 2) : "—"}`;
    document.getElementById("kpiRoe").textContent = roeStr;
  }

  /* -----------------------------
     Render table
  ------------------------------*/
  function renderTable(m){
    const months = m.saleMonth;
    const cols = ["M0"];
    for (let i=1; i<=months; i++) cols.push("M"+i);

    function rowHtml(typeLabel, typeClass, name, arr, opts={}){
      const {isNet=false, isBalance=false} = opts;
      let t = `<tr>
        <td class="left ${typeClass}">${typeLabel}</td>
        <td class="left2 ${typeClass}">${name}</td>`;

      for (let i=0; i<arr.length; i++){
        const v = arr[i];
        let cls = "muted";
        let text = "—";

        if (isBalance){
          cls = "bal";
          text = gbp(v);
        } else if (isNet){
          cls = "net";
          text = (v===0 ? "—" : gbp(v));
        } else {
          if (v !== 0){
            cls = v < 0 ? "neg" : "pos";
            text = gbp(v);
          }
        }

        t += `<td class="${cls}">${text}</td>`;
      }
      t += `</tr>`;
      return t;
    }

    const unitBaseLabel = (m.unitBase === "advance") ? "Advance" : "Invoice";
    const capBaseLabel  = (m.capBase === "outstanding") ? "Outstanding" : "Invoice";

    const head = `<table>
      <thead>
        <tr>
          <th class="left">Type</th>
          <th class="left2">Line Item</th>
          ${cols.map(c=>`<th>${c}</th>`).join("")}
        </tr>
      </thead>
      <tbody>`;

    const body =
        rowHtml("Capital", "cap", "Advance proceeds", m.lines.lineAdvance)
      + rowHtml("Fee", "fee", "Processing fee (M0)", m.lines.lineProcFee)
      + rowHtml("Fee", "fee", `Unit fee (${(m.unitFeePctMo*100).toFixed(4)}%/mo on ${unitBaseLabel})`, m.lines.lineUnitFee)
      + rowHtml("Capital", "cap", `Capital repayment @ M6 (${(m.capRepPct*100).toFixed(2)}% of ${capBaseLabel})`, m.lines.lineCapRep)
      + rowHtml("Capital", "cap", `Additional curtailment @ M${m.addCurtMonth} (${(m.addCurtPct*100).toFixed(2)}% of ${capBaseLabel})`, m.lines.lineAddCurt)
      + rowHtml("Capital", "cap", `Final payoff @ M${months}`, m.lines.lineFinalPay)
      + rowHtml("—", "net", "Net cashflow (loan IRR input)", m.lines.netLoan, {isNet:true})
      + rowHtml("—", "cap", "Outstanding principal balance (end of month)", m.lines.principalBal, {isBalance:true});

    const foot = `</tbody></table>`;

    document.getElementById("tableWrap").innerHTML = head + body + foot;

    const below = `
      <div>
        <strong>Sale price assumed at M${months}:</strong> ${gbp(m.salePrice)}
      </div>
      <div style="margin-top:6px;">
        <strong>Total fees:</strong> ${gbp(m.totalFees)} (Processing: ${gbp(m.procFee)}, Unit fees: ${gbp(m.totalUnitFees)})
      </div>
      <div style="margin-top:6px;">
        <strong>Absolute return:</strong> ${gbp(m.absReturnDollar)} (${isFinite(m.absReturnPct) ? pct(m.absReturnPct, 2) : "—"})
      </div>
      <div style="margin-top:6px;">
        <strong>ROE:</strong> ${isFinite(m.moic) ? m.moic.toFixed(2) + "x MOIC" : "—"} | ${isFinite(m.equityIrr) ? pct(m.equityIrr, 2) + " equity IRR" : "—"}
      </div>
    `;
    document.getElementById("belowBlock").innerHTML = below;
  }

  /* -----------------------------
     Recalc
  ------------------------------*/
  function recalc(){
    populateCurtailmentMonthDropdown();
    updateAdvanceLabels();
    updateUnitFeeFromScheduleIfEnabled();

    const capBase = getRadio("capBase");
    document.getElementById("addCurtBaseLabel").textContent = (capBase === "outstanding") ? "Outstanding" : "Invoice";

    const model = buildModel();
    renderKpis(model);
    renderTable(model);
  }

  /* -----------------------------
     Reset defaults
  ------------------------------*/
  function resetDefaults(){
    salePriceTouched = false;

    document.getElementById("invoice").value = "1,000,000";
    document.getElementById("salePrice").value = "1,100,000";

    setAdvanceSliderToPct(80);
    updateAdvanceLabels();

    document.getElementById("saleMonth").value = 12;
    document.getElementById("procFee").value = "250";

    document.getElementById("useSchedule").checked = true;
    document.querySelector(`input[name="unitBase"][value="invoice"]`).checked = true;

    document.getElementById("capRepPct").value = 10;
    document.querySelector(`input[name="capBase"][value="invoice"]`).checked = true;

    document.getElementById("addCurtPct").value = 0;

    populateCurtailmentMonthDropdown();
    document.getElementById("addCurtMonth").value = "6";

    updateUnitFeeFromScheduleIfEnabled();
    recalc();
  }

  /* -----------------------------
     Init ticks on slider
  ------------------------------*/
  function initAdvanceTicks(){
    const ticks = document.getElementById("advanceTicks");
    ticks.innerHTML = ADV_STEPS.map(x => `<span>${x}</span>`).join("");
  }

  /* -----------------------------
     Wire up events
  ------------------------------*/
  document.getElementById("recalc").addEventListener("click", recalc);
  document.getElementById("reset").addEventListener("click", resetDefaults);

  // Comma formatting on blur
  attachCommaFormatting("invoice");
  attachCommaFormatting("salePrice");
  attachCommaFormatting("procFee");

  // Invoice changes -> update sale price unless user touched it (recalc on input)
  document.getElementById("invoice").addEventListener("input", ()=>{
    maybeUpdateSalePriceFromInvoice();
    recalc();
  });

  // Sale price manual edits -> freeze auto-update
  document.getElementById("salePrice").addEventListener("input", ()=>{
    salePriceTouched = true;
    recalc();
  });

  // Advance slider
  document.getElementById("advanceSlider").addEventListener("input", ()=>{
    updateAdvanceLabels();
    updateUnitFeeFromScheduleIfEnabled();
    recalc();
  });

  // Use schedule toggle
  document.getElementById("useSchedule").addEventListener("change", ()=>{
    updateUnitFeeFromScheduleIfEnabled();
    recalc();
  });

  // Unit fee manual edits only matter when override is enabled
  document.getElementById("unitFeePct").addEventListener("input", ()=>{
    recalc();
  });

  // Other inputs
  ["saleMonth","capRepPct","addCurtPct","addCurtMonth"].forEach(id=>{
    document.getElementById(id).addEventListener("input", ()=>{
      if (id === "saleMonth") populateCurtailmentMonthDropdown();
      recalc();
    });
  });
  document.querySelectorAll('input[name="unitBase"]').forEach(el=>el.addEventListener("change", recalc));
  document.querySelectorAll('input[name="capBase"]').forEach(el=>el.addEventListener("change", recalc));

  // init
  initAdvanceTicks();
  populateCurtailmentMonthDropdown();
  setAdvanceSliderToPct(80);
  updateAdvanceLabels();
  updateUnitFeeFromScheduleIfEnabled();
  recalc();
</script>
</body>
</html>
