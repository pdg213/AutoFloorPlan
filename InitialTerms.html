<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Single Car Model — Loan APR + Equity Returns</title>
  <style>
    :root{
      --bg:#0b1220;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#26344f;
      --accent:#60a5fa;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    html,body{height:100%;}
    body{
      margin:0;
      font-family: var(--sans);
      background: radial-gradient(1200px 600px at 20% 0%, #142347 0%, var(--bg) 60%);
      color: var(--text);
    }
    .wrap{
      max-width: 1400px;
      margin: 22px auto;
      padding: 0 16px 36px;
    }

    /* Top KPI box */
    .hero{
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 16px 16px 14px;
      background: linear-gradient(180deg, rgba(96,165,250,0.18), rgba(0,0,0,0.18));
      box-shadow: 0 16px 34px rgba(0,0,0,0.28);
      margin-bottom: 14px;
      position: relative;
    }
    .heroTop{
      display:flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .hero h1{
      margin:0;
      font-size: 18px;
      font-weight: 750;
      letter-spacing: 0.2px;
    }
    .hero .sub{
      margin:0;
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.35;
    }
    .kpiGrid{
      display:grid;
      grid-template-columns: repeat(7, minmax(150px, 1fr));
      gap: 10px;
    }
    @media (max-width: 1200px){
      .kpiGrid{ grid-template-columns: repeat(3, minmax(160px, 1fr)); }
    }
    @media (max-width: 720px){
      .kpiGrid{ grid-template-columns: repeat(2, minmax(160px, 1fr)); }
    }
    .kpi{
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(38,52,79,0.9);
      border-radius: 14px;
      padding: 10px 10px 9px;
      min-height: 62px;
      position: relative;
    }
    .kpi[role="button"]{
      cursor: help;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .kpi:focus-visible{
      outline: none;
      box-shadow: 0 0 0 3px rgba(96,165,250,0.22);
    }
    .kpi .name{
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 6px;
    }
    .kpi .val{
      font-family: var(--mono);
      font-size: 14px;
      color: #eaf2ff;
      line-height: 1.2;
      white-space: pre-wrap;
    }
    .kpi .subval{
      margin-top: 6px;
      font-family: var(--mono);
      font-size: 11.5px;
      color: #c7d2fe;
      line-height: 1.2;
      opacity: 0.95;
      white-space: nowrap;
    }
    .pill{
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 11px;
      color: #c7d2fe;
      background: rgba(0,0,0,0.18);
      font-family: var(--mono);
      margin-left: 6px;
    }
    .kpiNarrative{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(38,52,79,0.9);
      background: rgba(0,0,0,0.18);
      color: #cbd5e1;
      font-size: 12.5px;
      line-height: 1.4;
    }
    .kpiNarrative strong{
      color:#eaf2ff;
      font-weight:800;
    }

    /* Tooltip */
    .tooltip{
      position: absolute;
      z-index: 9999;
      width: min(420px, calc(100vw - 40px));
      background: linear-gradient(180deg, rgba(15,23,42,0.98), rgba(11,20,40,0.98));
      border: 1px solid rgba(96,165,250,0.35);
      border-radius: 14px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.55);
      padding: 10px 12px;
      display: none;
      pointer-events: none;
      transform: translateY(6px);
      backdrop-filter: blur(6px);
    }
    .tooltip.show{ display:block; }
    .tooltip .tTitle{
      font-weight: 800;
      color: #eaf2ff;
      font-size: 12.5px;
      margin: 0 0 6px 0;
    }
    .tooltip .tDesc{
      margin: 0 0 8px 0;
      color: #cbd5e1;
      font-size: 12px;
      line-height: 1.35;
    }
    .tooltip .tBlock{
      border-top: 1px solid rgba(38,52,79,0.8);
      margin-top: 8px;
      padding-top: 8px;
      font-family: var(--mono);
      font-size: 11.5px;
      color: #dbeafe;
      line-height: 1.35;
      white-space: pre-wrap;
    }
    .tooltip .tLabel{
      color: #93a4c1;
      font-family: var(--sans);
      font-size: 11px;
      margin-bottom: 4px;
    }

    /* Inputs bar */
    .inputsCard{
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 14px 14px 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      box-shadow: 0 12px 28px rgba(0,0,0,0.25);
      margin-bottom: 14px;
    }
    .inputsHeader{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .inputsHeader h2{
      margin:0;
      font-size: 13.5px;
      font-weight: 750;
      color: #eaf2ff;
    }
    .actions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }
    button{
      appearance:none;
      border: 1px solid #355085;
      background: linear-gradient(180deg, rgba(96,165,250,0.28), rgba(96,165,250,0.12));
      color: #eaf2ff;
      padding: 8px 11px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 700;
      letter-spacing: 0.2px;
      font-size: 12.5px;
    }
    button:hover{ filter: brightness(1.05); }
    button.secondary{
      background: rgba(0,0,0,0.16);
      border-color: var(--border);
      color: var(--text);
      font-weight: 650;
    }

    .inputsRow{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: stretch;
    }
    .field{
      flex: 1 1 220px;
      min-width: 220px;
      background: rgba(0,0,0,0.18);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px 10px 9px;
    }
    .label{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .label span.small{
      font-family: var(--mono);
      font-size: 11px;
      color: #b6c2d6;
      opacity: 0.9;
    }
    input[type="text"], input[type="number"], select{
      width:100%;
      box-sizing:border-box;
      border-radius: 12px;
      border: 1px solid #314369;
      background: #0b1428;
      color: var(--text);
      padding: 9px 10px;
      font-size: 13.5px;
      outline:none;
    }
    input[type="text"]:focus, input[type="number"]:focus, select:focus{
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(96,165,250,0.18);
    }
    .toggle{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .toggle label{
      display:flex;
      gap: 7px;
      align-items:center;
      font-size: 12px;
      color: var(--muted);
      user-select:none;
    }
    .toggle input{ accent-color: var(--accent); }

    /* Slider styling */
    .sliderRow{
      display:flex;
      gap: 10px;
      align-items:center;
      margin-top: 6px;
    }
    input[type="range"]{
      width: 100%;
      accent-color: var(--accent);
    }
    .rangeVal{
      font-family: var(--mono);
      font-size: 12px;
      color: #eaf2ff;
      min-width: 64px;
      text-align: right;
    }
    .ticks{
      display:flex;
      justify-content: space-between;
      gap: 6px;
      margin-top: 4px;
      font-size: 10px;
      color: #93a4c1;
      font-family: var(--mono);
      opacity: 0.9;
    }
    .inlineNote{
      margin-top: 6px;
      color: #93a4c1;
      font-size: 11px;
      line-height: 1.25;
      font-family: var(--mono);
      opacity: 0.95;
    }

    /* Table card */
    .tableCard{
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      box-shadow: 0 12px 28px rgba(0,0,0,0.25);
    }
    .tableHeader{
      display:flex;
      justify-content: space-between;
      align-items: baseline;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }
    .tableHeader h2{
      margin:0;
      font-size: 13.5px;
      font-weight: 750;
      color: #eaf2ff;
    }
    .tableHeader .hint{
      margin:0;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }

    .tableWrap{
      overflow:auto;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.16);
    }
    table{
      width:100%;
      border-collapse: collapse;
      min-width: 1020px;
      font-size: 12px;
    }
    th, td{
      border-bottom: 1px solid rgba(38,52,79,0.75);
      padding: 9px 8px;
      text-align: right;
      white-space: nowrap;
    }
    th{
      position: sticky;
      top: 0;
      background: #0b1428;
      z-index: 1;
      font-weight: 800;
      color: #eaf2ff;
      border-bottom: 1px solid #334766;
    }
    th.left, td.left{
      text-align: left;
      position: sticky;
      left: 0;
      background: #0b1428;
      z-index: 2;
    }
    th.left2, td.left2{
      text-align: left;
      position: sticky;
      left: 120px;
      background: #0b1428;
      z-index: 2;
    }
    th.left, td.left{ min-width: 120px; max-width: 120px; }
    th.left2, td.left2{ min-width: 320px; max-width: 320px; }

    tr:last-child td{ border-bottom: none; }

    .muted{ color: var(--muted); }
    .cap{ color: #dbeafe; }
    .fee{ color: #fde68a; }
    .net{ color: #eaf2ff; font-weight: 800; }
    .neg{ color: #fecaca; }
    .pos{ color: #bbf7d0; }
    .bal{ color: #c7d2fe; font-weight: 700; }

    .below{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.45;
    }
    .below strong{
      color: #eaf2ff;
      font-weight: 800;
    }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- KPI / summary box -->
    <div class="hero">
      <div class="heroTop">
        <h1>Single Car Model <span class="pill">Loan APR vs Equity Returns</span></h1>
        <p class="sub">
          Loan IRR/APR excludes sale proceeds. Equity IRR uses sale price and treats fees + principal paydowns as equity cash out.
        </p>
      </div>

      <div class="kpiGrid">
        <div class="kpi">
          <div class="name">Purchase Price (Invoice)</div>
          <div class="val" id="kpiInvoice">—</div>
        </div>
        <div class="kpi">
          <div class="name">Advance Amount</div>
          <div class="val" id="kpiAdvance">—</div>
        </div>
        <div class="kpi">
          <div class="name">Sale Price</div>
          <div class="val" id="kpiSalePrice">—</div>
        </div>

        <div class="kpi" id="kpiTileLoanMo" role="button" tabindex="0" aria-label="Monthly Rate details">
          <div class="name">Monthly Rate (Loan IRR)</div>
          <div class="val" id="kpiLoanIrrMo">—</div>
        </div>

        <div class="kpi" id="kpiTileLoanApr" role="button" tabindex="0" aria-label="APR details">
          <div class="name">APR (Loan)</div>
          <div class="val" id="kpiLoanApr">—</div>
          <div class="subval" id="kpiTotalIntFees">Total Int. and Fees: —</div>
        </div>

        <div class="kpi" id="kpiTileAbs" role="button" tabindex="0" aria-label="Absolute Return details">
          <div class="name">Absolute Return</div>
          <div class="val" id="kpiAbsReturn">—</div>
        </div>

        <div class="kpi" id="kpiTileRoe" role="button" tabindex="0" aria-label="Return on Equity details">
          <div class="name">Return on Equity</div>
          <div class="val" id="kpiRoe">—</div>
        </div>
      </div>

      <div class="kpiNarrative" id="kpiNarrative">—</div>

      <!-- shared tooltip element -->
      <div class="tooltip" id="tooltip" aria-hidden="true">
        <div class="tTitle" id="ttTitle">—</div>
        <div class="tDesc" id="ttDesc">—</div>

        <div class="tBlock">
          <div class="tLabel">Formula</div>
          <div id="ttFormula">—</div>
        </div>

        <div class="tBlock">
          <div class="tLabel">With numbers</div>
          <div id="ttNumbers">—</div>
        </div>
      </div>
    </div>

    <!-- Inputs -->
    <div class="inputsCard">
      <div class="inputsHeader">
        <h2>Inputs</h2>
        <div class="actions">
          <button id="recalc">Recalculate</button>
          <button class="secondary" id="reset">Reset defaults</button>
        </div>
      </div>

      <div class="inputsRow">
        <div class="field">
          <div class="label">
            <span>Invoice Value (Purchase Price)</span>
            <span class="small">£</span>
          </div>
          <input id="invoice" type="text" inputmode="numeric" value="1,000,000" />
          <div class="inlineNote">Commas shown on blur.</div>
        </div>

        <div class="field">
          <div class="label">
            <span>Sale Price</span>
            <span class="small">£ (defaults +10%)</span>
          </div>
          <input id="salePrice" type="text" inputmode="numeric" value="1,100,000" />
          <div class="inlineNote">Auto-updates with invoice until overridden.</div>
        </div>

        <div class="field">
          <div class="label">
            <span>Advance Rate (slider)</span>
            <span class="small">%</span>
          </div>
          <div class="sliderRow">
            <input id="advanceSlider" type="range" min="0" max="8" step="1" value="8" />
            <div class="rangeVal" id="advancePctLabel">80%</div>
          </div>
          <div class="ticks" id="advanceTicks"></div>
          <div class="inlineNote">Steps: 40,45,50,55,60,65,70,75,80.</div>
        </div>

        <div class="field">
          <div class="label">
            <span>Sale Month</span>
            <span class="small">M1…MN</span>
          </div>
          <input id="saleMonth" type="number" min="1" step="1" value="12" />
        </div>

        <div class="field">
          <div class="label">
            <span>Processing Fee (M0)</span>
            <span class="small">£</span>
          </div>
          <input id="procFee" type="text" inputmode="numeric" value="250" />
          <div class="inlineNote">Included in fees.</div>
        </div>

        <div class="field">
          <div class="label">
            <span>Monthly Unit Fee</span>
            <span class="small">%/mo</span>
          </div>

          <div class="toggle" aria-label="Unit fee schedule vs override">
            <label><input type="checkbox" id="useSchedule" checked /> Use schedule (based on advance rate)</label>
          </div>

          <input id="unitFeePct" type="number" min="0" step="0.01" value="0.63" />

          <div class="toggle" aria-label="Unit fee base">
            <label><input type="radio" name="unitBase" value="invoice" checked /> charge on Invoice</label>
            <label><input type="radio" name="unitBase" value="advance" /> charge on Advance*</label>
          </div>

          <div class="inlineNote" id="scheduleNote">
            Schedule: 80→0.63, 75→0.59, 70→0.55, 65→0.51, 60→0.47, 55→0.43, 50→0.39, 45→0.35, 40→0.31
            <br>*If charging on Advance, fee is computed on prior month ending principal (paydown at M6 reduces fee starting M7).
          </div>
        </div>

        <div class="field">
          <div class="label">
            <span>Capital Repayment @ M6 (Day 180)</span>
            <span class="small">% + base</span>
          </div>
          <input id="capRepPct" type="number" min="0" step="0.1" value="10" />
          <div class="toggle" aria-label="Capital repayment base">
            <label><input type="radio" name="capBase" value="invoice" checked /> % of Invoice</label>
            <label><input type="radio" name="capBase" value="outstanding" /> % of Outstanding</label>
          </div>
        </div>

        <div class="field">
          <div class="label">
            <span>Additional Curtailment (Optional)</span>
            <span class="small">% + month</span>
          </div>
          <input id="addCurtPct" type="number" min="0" step="0.1" value="0" />
          <div style="margin-top:8px;">
            <select id="addCurtMonth" aria-label="Additional curtailment month"></select>
          </div>
          <div class="label" style="margin-top:8px;">
            <span class="muted">Base matches Capital Repayment</span>
            <span class="small" id="addCurtBaseLabel">Invoice</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="tableCard">
      <div class="tableHeader">
        <h2>Loan Cashflows (for Loan IRR/APR)</h2>
        <p class="hint">
          Borrower perspective. Sale price is not included in loan APR.
          Principal balance shown end-of-month after principal payments.
        </p>
      </div>
      <div class="tableWrap" id="tableWrap"></div>
      <div class="below" id="belowBlock"></div>
    </div>

  </div>

<script>
  const ADV_STEPS = [40, 45, 50, 55, 60, 65, 70, 75, 80];
  const UNIT_FEE_BY_ADV = {80:0.63,75:0.59,70:0.55,65:0.51,60:0.47,55:0.43,50:0.39,45:0.35,40:0.31};

  let salePriceTouched = false;
  let lastModel = null;

  function parseNumberFromText(s){
    if (s == null) return 0;
    const cleaned = String(s).replace(/[^0-9.\-]/g, "");
    const v = Number(cleaned);
    return isFinite(v) ? v : 0;
  }
  function formatIntWithCommas(n){
    const v = Math.round(Number(n));
    if (!isFinite(v)) return "";
    return v.toLocaleString(undefined, {maximumFractionDigits: 0});
  }
  function gbp(x){
    const sign = x < 0 ? "-" : "";
    const v = Math.abs(x);
    return sign + "£" + v.toLocaleString(undefined, {maximumFractionDigits: 2, minimumFractionDigits: 0});
  }
  function pct(x, decimals=2){
    if (!isFinite(x)) return "—";
    return (x*100).toFixed(decimals) + "%";
  }
  function clampInt(v, min, max){
    v = Math.round(Number(v));
    if (!isFinite(v)) v = min;
    return Math.max(min, Math.min(max, v));
  }
  function getRadio(name){
    const el = document.querySelector(`input[name="${name}"]:checked`);
    return el ? el.value : null;
  }

  // IRR helpers
  function npv(rate, cfs){
    let s = 0;
    for (let t=0; t<cfs.length; t++){
      s += cfs[t] / Math.pow(1+rate, t);
    }
    return s;
  }
  function irrMonthly(cfs){
    let hasPos=false, hasNeg=false;
    for (const x of cfs){
      if (x > 0) hasPos = true;
      if (x < 0) hasNeg = true;
    }
    if (!(hasPos && hasNeg)) return NaN;

    let lo = -0.9999;
    let hi = 5.0;
    let fLo = npv(lo, cfs);
    let fHi = npv(hi, cfs);

    let iter=0;
    while (fLo*fHi > 0 && hi < 100 && iter < 60){
      hi *= 2;
      fHi = npv(hi, cfs);
      iter++;
    }
    if (fLo*fHi > 0) return NaN;

    for (let i=0; i<140; i++){
      const mid = (lo+hi)/2;
      const fMid = npv(mid, cfs);
      if (Math.abs(fMid) < 1e-9) return mid;
      if (fLo*fMid <= 0){
        hi = mid; fHi = fMid;
      }else{
        lo = mid; fLo = fMid;
      }
    }
    return (lo+hi)/2;
  }

  function sumContribDistrib(cfs){
    let contrib = 0;
    let distrib = 0;
    for (const x of cfs){
      if (x < 0) contrib += -x;
      else distrib += x;
    }
    return { contrib, distrib };
  }

  function populateCurtailmentMonthDropdown(){
    const sel = document.getElementById("addCurtMonth");
    const saleMonth = clampInt(document.getElementById("saleMonth").value, 1, 120);
    const current = Number(sel.value) || 6;

    sel.innerHTML = "";
    const maxM = Math.max(12, saleMonth);
    for (let m=1; m<=maxM; m++){
      const opt = document.createElement("option");
      opt.value = String(m);
      opt.textContent = `Month ${m}`;
      sel.appendChild(opt);
    }
    sel.value = String(Math.min(Math.max(current, 1), maxM));
  }

  function getAdvancePctFromSlider(){
    const idx = clampInt(document.getElementById("advanceSlider").value, 0, ADV_STEPS.length-1);
    return ADV_STEPS[idx];
  }
  function setAdvanceSliderToPct(pctVal){
    const idx = ADV_STEPS.indexOf(pctVal);
    document.getElementById("advanceSlider").value = String(idx >= 0 ? idx : (ADV_STEPS.length-1));
  }
  function updateAdvanceLabels(){
    const adv = getAdvancePctFromSlider();
    document.getElementById("advancePctLabel").textContent = adv.toFixed(0) + "%";
  }
  function updateUnitFeeFromScheduleIfEnabled(){
    const use = document.getElementById("useSchedule").checked;
    const unitEl = document.getElementById("unitFeePct");
    if (!use) {
      unitEl.disabled = false;
      return;
    }
    const adv = getAdvancePctFromSlider();
    const fee = UNIT_FEE_BY_ADV[adv];
    unitEl.value = (fee != null) ? fee.toFixed(2) : unitEl.value;
    unitEl.disabled = true;
  }

  function maybeUpdateSalePriceFromInvoice(){
    if (salePriceTouched) return;
    const invoice = parseNumberFromText(document.getElementById("invoice").value);
    const suggested = Math.round(invoice * 1.10);
    document.getElementById("salePrice").value = formatIntWithCommas(suggested);
  }

  function attachCommaFormatting(id){
    const el = document.getElementById(id);
    el.addEventListener("blur", ()=>{
      const v = parseNumberFromText(el.value);
      el.value = formatIntWithCommas(v);
    });
  }

  function buildModel(){
    const invoice = Math.max(0, parseNumberFromText(document.getElementById("invoice").value));
    const salePrice = Math.max(0, parseNumberFromText(document.getElementById("salePrice").value));

    const advancePct = getAdvancePctFromSlider() / 100;
    const saleMonth = clampInt(document.getElementById("saleMonth").value, 1, 120);

    const procFee = Math.max(0, parseNumberFromText(document.getElementById("procFee").value));

    const unitFeePctMo = Math.max(0, Number(document.getElementById("unitFeePct").value) || 0) / 100;
    const unitBase = getRadio("unitBase"); // invoice|advance

    const capRepPct = Math.max(0, Number(document.getElementById("capRepPct").value) || 0) / 100;
    const capBase = getRadio("capBase"); // invoice|outstanding

    const addCurtPct = Math.max(0, Number(document.getElementById("addCurtPct").value) || 0) / 100;
    const addCurtMonth = clampInt(document.getElementById("addCurtMonth").value, 1, 120);

    const months = saleMonth;
    const advanceAmt = invoice * advancePct;

    const zeros = () => Array(months+1).fill(0);

    // Loan cashflow lines (borrower view)
    const lineAdvance   = zeros();
    const lineProcFee   = zeros();
    const lineUnitFee   = zeros();
    const lineCapRep    = zeros();
    const lineAddCurt   = zeros();
    const lineFinalPay  = zeros();
    const netLoan       = zeros();

    // Principal balance end-of-month after principal payments
    const principalBalEnd = Array(months+1).fill(0);

    // Loan: M0
    lineAdvance[0] = advanceAmt;
    lineProcFee[0] = -procFee;

    // Principal schedule
    let principal = advanceAmt;
    const events = [];
    if (months >= 6 && capRepPct > 0) events.push({m: 6, kind: "cap", pct: capRepPct});
    if (addCurtPct > 0 && addCurtMonth <= months) events.push({m: addCurtMonth, kind: "add", pct: addCurtPct});
    events.sort((a,b)=>a.m-b.m);

    function curtailAmt(pct){
      if (pct <= 0) return 0;
      if (capBase === "invoice") return invoice * pct;
      return principal * pct;
    }

    let eIdx = 0;
    for (let m=0; m<=months; m++){
      while (eIdx < events.length && events[eIdx].m === m){
        const e = events[eIdx];
        const amt = Math.min(principal, curtailAmt(e.pct));
        if (amt > 0){
          if (e.kind === "cap") lineCapRep[m] += -amt;
          else lineAddCurt[m] += -amt;
          principal -= amt;
        }
        eIdx++;
      }
      if (m === months){
        lineFinalPay[m] = -principal;
        principal = 0;
      }
      principalBalEnd[m] = principal;
    }

    // Unit fee
    for (let m=1; m<=months; m++){
      if (unitBase === "invoice"){
        lineUnitFee[m] = -(invoice * unitFeePctMo);
      } else {
        // Charged on prior month ending principal; M6 paydown reduces fee starting M7
        const baseAmt = principalBalEnd[m-1];
        lineUnitFee[m] = -(baseAmt * unitFeePctMo);
      }
    }

    // Net loan CF for IRR
    for (let m=0; m<=months; m++){
      netLoan[m] =
        lineAdvance[m] +
        lineProcFee[m] +
        lineUnitFee[m] +
        lineCapRep[m] +
        lineAddCurt[m] +
        lineFinalPay[m];
    }

    const loanIrrMo = irrMonthly(netLoan);
    const loanApr = isFinite(loanIrrMo) ? (Math.pow(1+loanIrrMo, 12) - 1) : NaN;

    // Total fees
    let totalUnitFees = 0;
    for (let m=1; m<=months; m++) totalUnitFees += -lineUnitFee[m];
    const totalFees = procFee + totalUnitFees;

    // Absolute return (your definition)
    const absReturnDollar = salePrice - invoice - totalFees;
    const absReturnPct = (invoice > 0) ? ((salePrice - totalFees)/invoice - 1) : NaN;

    // Equity cashflows (for equity IRR): treat fees + paydowns + payoff as equity outflows
    const equity = Array(months+1).fill(0);
    equity[0] = -(invoice - advanceAmt) - procFee;
    for (let m=1; m<=months; m++){
      equity[m] += lineUnitFee[m];
      equity[m] += lineCapRep[m];
      equity[m] += lineAddCurt[m];
      equity[m] += lineFinalPay[m];
    }
    equity[months] += salePrice;

    const equityIrrMo = irrMonthly(equity);
    const equityIrr = isFinite(equityIrrMo) ? (Math.pow(1+equityIrrMo, 12) - 1) : NaN;

    // MOIC (correct): total distributions / total contributions from equity CF series
    const { contrib: equityContrib, distrib: equityDistrib } = sumContribDistrib(equity);
    const moic = (equityContrib > 0) ? (equityDistrib / equityContrib) : NaN;

    // Exit debt payoff (remaining principal)
    const debtPayoffAtExit = -lineFinalPay[months];
    const netProceedsSaleMinusDebt = salePrice - debtPayoffAtExit;

    // Break-even sale price (profit = 0 net of financing)
    const breakEvenSale = invoice + totalFees;

    // Break-even MOIC: re-run contrib/distrib with terminal sale swapped to breakEvenSale
    const equityBE = equity.slice();
    equityBE[months] += (breakEvenSale - salePrice);
    const { contrib: beContrib, distrib: beDistrib } = sumContribDistrib(equityBE);
    const breakEvenMoic = (beContrib > 0) ? (beDistrib / beContrib) : NaN;

    // Target sale for 30% equity IRR (annual)
    const targetAnnual = 0.30;
    const rTargetMo = Math.pow(1 + targetAnnual, 1/12) - 1;

    const equityNoSale = equity.slice();
    equityNoSale[months] -= salePrice;

    let pvOther = 0;
    for (let t=0; t<=months; t++){
      pvOther += equityNoSale[t] / Math.pow(1 + rTargetMo, t);
    }
    const targetSaleFor30IRR = -pvOther * Math.pow(1 + rTargetMo, months);

    return {
      invoice, salePrice, advancePct, saleMonth: months, procFee,
      unitFeePctMo, unitBase, capRepPct, capBase,
      addCurtPct, addCurtMonth,
      advanceAmt,
      totalUnitFees, totalFees,
      absReturnDollar, absReturnPct,
      loanIrrMo, loanApr,
      equityIrr,
      equityContrib, equityDistrib,
      moic,
      debtPayoffAtExit,
      netProceedsSaleMinusDebt,
      breakEvenSale, breakEvenMoic,
      targetSaleFor30IRR,
      lines: { lineAdvance, lineProcFee, lineUnitFee, lineCapRep, lineAddCurt, lineFinalPay, netLoan, principalBalEnd }
    };
  }

  function renderKpis(m){
    document.getElementById("kpiInvoice").textContent = gbp(m.invoice);
    document.getElementById("kpiAdvance").textContent = gbp(m.advanceAmt);
    document.getElementById("kpiSalePrice").textContent = gbp(m.salePrice);

    document.getElementById("kpiLoanIrrMo").textContent = isFinite(m.loanIrrMo) ? pct(m.loanIrrMo, 3) : "—";
    document.getElementById("kpiLoanApr").textContent   = isFinite(m.loanApr)   ? pct(m.loanApr, 2)   : "—";
    document.getElementById("kpiTotalIntFees").textContent = `Total Int. and Fees: ${gbp(m.totalFees)}`;

    const absStr = `${gbp(m.absReturnDollar)}  |  ${isFinite(m.absReturnPct) ? pct(m.absReturnPct, 2) : "—"}`;
    document.getElementById("kpiAbsReturn").textContent = absStr;

    document.getElementById("kpiRoe").textContent =
      `${isFinite(m.moic) ? m.moic.toFixed(2) + "x" : "—"}  |  ${isFinite(m.equityIrr) ? pct(m.equityIrr, 2) : "—"}`;

    const be = gbp(m.breakEvenSale);
    const beMoicTxt = isFinite(m.breakEvenMoic) ? `${m.breakEvenMoic.toFixed(2)}x` : "—";
    const y = (isFinite(m.targetSaleFor30IRR) && m.targetSaleFor30IRR >= 0) ? gbp(m.targetSaleFor30IRR) : "—";

    document.getElementById("kpiNarrative").innerHTML =
      `We purchased the vehicle at <strong>${gbp(m.invoice)}</strong> and need to sell it at <strong>${be}</strong> in order to make exactly <strong>£0</strong> net of financing fees/interest ` +
      `(≈ <strong>${beMoicTxt} MOIC</strong>). ` +
      `We need to sell it at <strong>${y}</strong> to realize a <strong>30% return on the equity (IRR)</strong>.`;
  }

  function renderTable(m){
    const months = m.saleMonth;
    const cols = ["M0"];
    for (let i=1; i<=months; i++) cols.push("M"+i);

    function rowHtml(typeLabel, typeClass, name, arr, opts={}){
      const {isNet=false, isBalance=false} = opts;
      let t = `<tr>
        <td class="left ${typeClass}">${typeLabel}</td>
        <td class="left2 ${typeClass}">${name}</td>`;

      for (let i=0; i<arr.length; i++){
        const v = arr[i];
        let cls = "muted";
        let text = "—";

        if (isBalance){
          cls = "bal";
          text = gbp(v);
        } else if (isNet){
          cls = "net";
          text = (v===0 ? "—" : gbp(v));
        } else {
          if (v !== 0){
            cls = v < 0 ? "neg" : "pos";
            text = gbp(v);
          }
        }
        t += `<td class="${cls}">${text}</td>`;
      }
      t += `</tr>`;
      return t;
    }

    const unitBaseLabel = (m.unitBase === "advance") ? "Prior month ending principal" : "Invoice";
    const capBaseLabel  = (m.capBase === "outstanding") ? "Outstanding" : "Invoice";

    const head = `<table>
      <thead>
        <tr>
          <th class="left">Type</th>
          <th class="left2">Line Item</th>
          ${cols.map(c=>`<th>${c}</th>`).join("")}
        </tr>
      </thead>
      <tbody>`;

    const body =
        rowHtml("Capital", "cap", "Advance proceeds", m.lines.lineAdvance)
      + rowHtml("Fee", "fee", "Processing fee (M0)", m.lines.lineProcFee)
      + rowHtml("Fee", "fee", `Unit fee (${(m.unitFeePctMo*100).toFixed(4)}%/mo on ${unitBaseLabel})`, m.lines.lineUnitFee)
      + rowHtml("Capital", "cap", `Capital repayment @ M6 (${(m.capRepPct*100).toFixed(2)}% of ${capBaseLabel})`, m.lines.lineCapRep)
      + rowHtml("Capital", "cap", `Additional curtailment @ M${m.addCurtMonth} (${(m.addCurtPct*100).toFixed(2)}% of ${capBaseLabel})`, m.lines.lineAddCurt)
      + rowHtml("Capital", "cap", `Final payoff @ M${months}`, m.lines.lineFinalPay)
      + rowHtml("—", "net", "Net cashflow (loan IRR input)", m.lines.netLoan, {isNet:true})
      + rowHtml("—", "cap", "Outstanding principal balance (end of month)", m.lines.principalBalEnd, {isBalance:true});

    const foot = `</tbody></table>`;
    document.getElementById("tableWrap").innerHTML = head + body + foot;

    const below = `
      <div><strong>Sale price assumed at M${months}:</strong> ${gbp(m.salePrice)}</div>
      <div style="margin-top:6px;"><strong>Debt payoff at exit:</strong> ${gbp(m.debtPayoffAtExit)} (remaining principal)</div>
      <div style="margin-top:6px;"><strong>Sale − Debt payoff:</strong> ${gbp(m.netProceedsSaleMinusDebt)}</div>
      <div style="margin-top:6px;"><strong>Total equity contributions:</strong> ${gbp(m.equityContrib)} | <strong>Total equity distributions:</strong> ${gbp(m.equityDistrib)}</div>
      <div style="margin-top:6px;"><strong>Total Int. and Fees:</strong> ${gbp(m.totalFees)} (Processing: ${gbp(m.procFee)}, Unit fees: ${gbp(m.totalUnitFees)})</div>
      <div style="margin-top:6px;"><strong>Profit net of financing:</strong> ${gbp(m.absReturnDollar)} (${isFinite(m.absReturnPct) ? pct(m.absReturnPct, 2) : "—"})</div>
    `;
    document.getElementById("belowBlock").innerHTML = below;
  }

  /* Tooltip content */
  function setTooltipContent(kind, m){
    const titleEl = document.getElementById("ttTitle");
    const descEl = document.getElementById("ttDesc");
    const formulaEl = document.getElementById("ttFormula");
    const numbersEl = document.getElementById("ttNumbers");
    if (!m) return;

    if (kind === "loanMo"){
      titleEl.textContent = "Monthly Rate (Loan IRR)";
      descEl.textContent = "Monthly cost of the loan to the borrower, computed as the IRR of the loan cashflows (excluding sale proceeds).";
      formulaEl.textContent = `IRR_monthly = IRR( [NetLoanCF_M0, NetLoanCF_M1, …, NetLoanCF_MN] )`;
      numbersEl.textContent =
`M0 net = ${gbp(m.lines.netLoan[0])}
M${m.saleMonth} net = ${gbp(m.lines.netLoan[m.saleMonth])}
Result = ${isFinite(m.loanIrrMo) ? pct(m.loanIrrMo, 3) : "—"}`;
    }

    if (kind === "loanApr"){
      titleEl.textContent = "APR (Loan)";
      descEl.textContent = "Annualized rate derived from the monthly loan IRR, compounding monthly.";
      formulaEl.textContent = `APR = (1 + IRR_monthly)^12 − 1`;
      numbersEl.textContent =
`IRR_monthly = ${isFinite(m.loanIrrMo) ? pct(m.loanIrrMo, 3) : "—"}
APR = ${isFinite(m.loanApr) ? pct(m.loanApr, 2) : "—"}`;
    }

    if (kind === "abs"){
      titleEl.textContent = "Absolute Return";
      descEl.textContent = "Profit on the unit after financing costs, shown in £ and as a % of invoice per your definition.";
      formulaEl.textContent =
`£ Return = SalePrice − Invoice − Fees
% Return = (SalePrice − Fees) / Invoice − 1`;
      numbersEl.textContent =
`SalePrice = ${gbp(m.salePrice)}
Invoice   = ${gbp(m.invoice)}
Fees      = ${gbp(m.totalFees)}

£ Return  = ${gbp(m.absReturnDollar)}
% Return  = ${isFinite(m.absReturnPct) ? pct(m.absReturnPct, 2) : "—"}`;
    }

    if (kind === "roe"){
      titleEl.textContent = "Return on Equity";
      descEl.textContent = "MOIC is computed as total equity distributions divided by total equity contributions (from the equity cashflow series).";
      formulaEl.textContent =
`Contributions = Σ max(-EquityCF_t, 0)
Distributions  = Σ max( EquityCF_t, 0)
MOIC = Distributions / Contributions`;
      numbersEl.textContent =
`Contributions = ${gbp(m.equityContrib)}
Distributions  = ${gbp(m.equityDistrib)}

MOIC = ${isFinite(m.moic) ? m.moic.toFixed(2) + "x" : "—"}
Equity IRR (annual) = ${isFinite(m.equityIrr) ? pct(m.equityIrr, 2) : "—"}`;
    }
  }

  function positionTooltip(anchorEl){
    const tt = document.getElementById("tooltip");
    const a = anchorEl.getBoundingClientRect();
    const t = tt.getBoundingClientRect();

    const spaceBelow = window.innerHeight - a.bottom;
    const showAbove = spaceBelow < 220;

    let top = (showAbove ? (a.top - t.height - 10) : (a.bottom + 10));
    let left = a.left;

    const pad = 12;
    left = Math.min(left, window.innerWidth - t.width - pad);
    left = Math.max(left, pad);

    top = Math.max(top, pad);
    top = Math.min(top, window.innerHeight - t.height - pad);

    tt.style.left = (left + window.scrollX) + "px";
    tt.style.top  = (top + window.scrollY) + "px";
  }

  let activeTooltipKey = null;

  function showTooltipFor(anchorEl, kind){
    const tt = document.getElementById("tooltip");
    activeTooltipKey = kind;
    setTooltipContent(kind, lastModel);
    tt.classList.add("show");
    tt.setAttribute("aria-hidden", "false");
    positionTooltip(anchorEl);
  }
  function hideTooltip(){
    const tt = document.getElementById("tooltip");
    activeTooltipKey = null;
    tt.classList.remove("show");
    tt.setAttribute("aria-hidden", "true");
  }
  function attachTooltipHandlers(tileId, kind){
    const el = document.getElementById(tileId);

    el.addEventListener("mouseenter", ()=> showTooltipFor(el, kind));
    el.addEventListener("mouseleave", ()=> hideTooltip());

    el.addEventListener("focus", ()=> showTooltipFor(el, kind));
    el.addEventListener("blur", ()=> hideTooltip());

    // tap/click toggle
    el.addEventListener("click", (e)=>{
      const tt = document.getElementById("tooltip");
      const isOpen = tt.classList.contains("show") && activeTooltipKey === kind;
      if (isOpen) hideTooltip();
      else showTooltipFor(el, kind);
      e.stopPropagation();
    });
  }
  document.addEventListener("click", ()=> hideTooltip());
  window.addEventListener("scroll", ()=> { if (activeTooltipKey) hideTooltip(); }, {passive:true});
  window.addEventListener("resize", ()=> { if (activeTooltipKey) hideTooltip(); });

  function initAdvanceTicks(){
    const ticks = document.getElementById("advanceTicks");
    ticks.innerHTML = ADV_STEPS.map(x => `<span>${x}</span>`).join("");
  }

  function recalc(){
    // If anything blows up, make it obvious (and keep console useful)
    try{
      populateCurtailmentMonthDropdown();
      updateAdvanceLabels();
      updateUnitFeeFromScheduleIfEnabled();

      const capBase = getRadio("capBase");
      document.getElementById("addCurtBaseLabel").textContent = (capBase === "outstanding") ? "Outstanding" : "Invoice";

      const model = buildModel();
      lastModel = model;

      renderKpis(model);
      renderTable(model);

      if (activeTooltipKey){
        const map = {
          loanMo: document.getElementById("kpiTileLoanMo"),
          loanApr: document.getElementById("kpiTileLoanApr"),
          abs: document.getElementById("kpiTileAbs"),
          roe: document.getElementById("kpiTileRoe")
        };
        const anchor = map[activeTooltipKey];
        if (anchor){
          setTooltipContent(activeTooltipKey, lastModel);
          positionTooltip(anchor);
        }
      }
    } catch (err){
      console.error("Recalc error:", err);
      // Leave KPIs visible as "—" but provide a quick signal if needed:
      // alert("Calculation error — open DevTools Console for details.");
    }
  }

  function resetDefaults(){
    salePriceTouched = false;

    document.getElementById("invoice").value = "1,000,000";
    document.getElementById("salePrice").value = "1,100,000";

    setAdvanceSliderToPct(80);
    updateAdvanceLabels();

    document.getElementById("saleMonth").value = 12;
    document.getElementById("procFee").value = "250";

    document.getElementById("useSchedule").checked = true;
    document.querySelector('input[name="unitBase"][value="invoice"]').checked = true;

    document.getElementById("capRepPct").value = 10;
    document.querySelector('input[name="capBase"][value="invoice"]').checked = true;

    document.getElementById("addCurtPct").value = 0;

    populateCurtailmentMonthDropdown();
    document.getElementById("addCurtMonth").value = "6";

    updateUnitFeeFromScheduleIfEnabled();
    recalc();
  }

  // Events
  document.getElementById("recalc").addEventListener("click", recalc);
  document.getElementById("reset").addEventListener("click", resetDefaults);

  attachCommaFormatting("invoice");
  attachCommaFormatting("salePrice");
  attachCommaFormatting("procFee");

  document.getElementById("invoice").addEventListener("input", ()=>{
    maybeUpdateSalePriceFromInvoice();
    recalc();
  });
  document.getElementById("salePrice").addEventListener("input", ()=>{
    salePriceTouched = true;
    recalc();
  });

  document.getElementById("advanceSlider").addEventListener("input", ()=>{
    updateAdvanceLabels();
    updateUnitFeeFromScheduleIfEnabled();
    recalc();
  });

  document.getElementById("useSchedule").addEventListener("change", ()=>{
    updateUnitFeeFromScheduleIfEnabled();
    recalc();
  });

  document.getElementById("unitFeePct").addEventListener("input", ()=> recalc());

  ["saleMonth","capRepPct","addCurtPct","addCurtMonth"].forEach(id=>{
    document.getElementById(id).addEventListener("input", ()=>{
      if (id === "saleMonth") populateCurtailmentMonthDropdown();
      recalc();
    });
  });

  document.querySelectorAll('input[name="unitBase"]').forEach(el=>el.addEventListener("change", recalc));
  document.querySelectorAll('input[name="capBase"]').forEach(el=>el.addEventListener("change", recalc));

  // Tooltip handlers
  attachTooltipHandlers("kpiTileLoanMo", "loanMo");
  attachTooltipHandlers("kpiTileLoanApr", "loanApr");
  attachTooltipHandlers("kpiTileAbs", "abs");
  attachTooltipHandlers("kpiTileRoe", "roe");

  // init
  initAdvanceTicks();
  populateCurtailmentMonthDropdown();
  setAdvanceSliderToPct(80);
  updateAdvanceLabels();
  updateUnitFeeFromScheduleIfEnabled();
  recalc();
</script>
</body>
</html>
