<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Single Car Stocking Model (Cashflows + IRR)</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#101a2e;
      --panel2:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#26344f;
      --accent:#60a5fa;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#f87171;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    html,body{height:100%;}
    body{
      margin:0;
      font-family: var(--sans);
      background: radial-gradient(1200px 600px at 20% 0%, #142347 0%, var(--bg) 60%);
      color: var(--text);
    }
    .wrap{
      max-width: 1200px;
      margin: 28px auto;
      padding: 0 18px 36px;
    }
    h1{
      font-size: 20px;
      font-weight: 650;
      margin: 0 0 8px;
      letter-spacing: 0.2px;
    }
    .sub{
      color: var(--muted);
      font-size: 13px;
      margin: 0 0 18px;
      line-height: 1.35;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.2fr 1fr;
      gap:14px;
      align-items: start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px 14px 12px;
      box-shadow: 0 12px 28px rgba(0,0,0,0.25);
    }
    .card h2{
      font-size: 14px;
      margin: 0 0 10px;
      font-weight: 650;
      color: #eaf2ff;
    }
    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 640px){
      .form{ grid-template-columns: 1fr; }
    }
    .field{
      background: rgba(0,0,0,0.18);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 10px 8px;
    }
    .label{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .label span.small{
      font-family: var(--mono);
      font-size: 11px;
      color: #b6c2d6;
      opacity: 0.9;
    }
    input[type="number"], select{
      width:100%;
      box-sizing:border-box;
      border-radius: 10px;
      border: 1px solid #314369;
      background: #0b1428;
      color: var(--text);
      padding: 9px 10px;
      font-size: 14px;
      outline:none;
    }
    input[type="number"]:focus, select:focus{
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(96,165,250,0.18);
    }
    .row{
      display:flex;
      gap: 10px;
      align-items: center;
      margin-top: 8px;
    }
    .toggle{
      display:flex;
      gap: 8px;
      align-items:center;
      flex-wrap: wrap;
    }
    .toggle label{
      display:flex;
      gap: 7px;
      align-items:center;
      font-size: 12px;
      color: var(--muted);
      user-select:none;
    }
    .toggle input{ accent-color: var(--accent); }
    .actions{
      margin-top: 12px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }
    button{
      appearance:none;
      border: 1px solid #355085;
      background: linear-gradient(180deg, rgba(96,165,250,0.28), rgba(96,165,250,0.12));
      color: #eaf2ff;
      padding: 9px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 650;
      letter-spacing: 0.2px;
    }
    button:hover{ filter: brightness(1.05); }
    button.secondary{
      background: rgba(0,0,0,0.16);
      border-color: var(--border);
      color: var(--text);
      font-weight: 600;
    }
    .note{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
      margin-top: 10px;
    }
    .kpis{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 640px){
      .kpis{ grid-template-columns: 1fr; }
    }
    .kpi{
      background: rgba(0,0,0,0.18);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 10px 9px;
    }
    .kpi .name{
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 6px;
    }
    .kpi .val{
      font-family: var(--mono);
      font-size: 14px;
      color: #eaf2ff;
    }
    .tableWrap{
      overflow:auto;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.16);
    }
    table{
      width:100%;
      border-collapse: collapse;
      min-width: 900px;
      font-size: 12px;
    }
    th, td{
      border-bottom: 1px solid rgba(38,52,79,0.75);
      padding: 9px 8px;
      text-align: right;
      white-space: nowrap;
    }
    th{
      position: sticky;
      top: 0;
      background: #0b1428;
      z-index: 1;
      font-weight: 700;
      color: #eaf2ff;
      border-bottom: 1px solid #334766;
    }
    th.left, td.left{
      text-align: left;
      position: sticky;
      left: 0;
      background: #0b1428;
      z-index: 2;
    }
    th.left2, td.left2{
      text-align: left;
      position: sticky;
      left: 120px;
      background: #0b1428;
      z-index: 2;
    }
    /* widths for sticky columns */
    th.left, td.left{ min-width: 120px; max-width: 120px; }
    th.left2, td.left2{ min-width: 240px; max-width: 240px; }

    tr:last-child td{ border-bottom: none; }
    .muted{ color: var(--muted); }
    .cap{ color: #dbeafe; }
    .fee{ color: #fde68a; }
    .net{ color: #eaf2ff; font-weight: 700; }
    .neg{ color: #fecaca; }
    .pos{ color: #bbf7d0; }
    .smallPrint{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.45;
    }
    .badge{
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 11px;
      color: #c7d2fe;
      background: rgba(0,0,0,0.18);
      font-family: var(--mono);
      margin-left: 6px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Single Car Stocking Model <span class="badge">cashflows + IRR</span></h1>
    <p class="sub">
      Simple, single-unit model: advance at M0, monthly fees at month-end, optional curtailments, and full payoff at sale month.
      Cashflows are borrower perspective (inflows positive, outflows negative).
    </p>

    <div class="grid">
      <div class="card">
        <h2>Inputs</h2>

        <div class="form">
          <div class="field">
            <div class="label">
              <span>Invoice Value (GBP)</span>
              <span class="small">£</span>
            </div>
            <input id="invoice" type="number" min="0" step="1000" value="1000000" />
          </div>

          <div class="field">
            <div class="label">
              <span>Advance %</span>
              <span class="small">%</span>
            </div>
            <input id="advancePct" type="number" min="0" max="100" step="0.1" value="80" />
          </div>

          <div class="field">
            <div class="label">
              <span>Sale Month (M1…MN)</span>
              <span class="small">months</span>
            </div>
            <input id="saleMonth" type="number" min="1" step="1" value="12" />
          </div>

          <div class="field">
            <div class="label">
              <span>Processing Fee (M0)</span>
              <span class="small">£</span>
            </div>
            <input id="procFee" type="number" min="0" step="10" value="250" />
          </div>

          <div class="field">
            <div class="label">
              <span>Unit Fee % per Month</span>
              <span class="small">%/mo</span>
            </div>
            <input id="unitFeePct" type="number" min="0" step="0.01" value="0.65" />
            <div class="row">
              <div class="toggle" aria-label="Unit fee base">
                <label><input type="radio" name="unitBase" value="invoice" checked /> charge on Invoice</label>
                <label><input type="radio" name="unitBase" value="advance" /> charge on Advance</label>
              </div>
            </div>
          </div>

          <div class="field">
            <div class="label">
              <span>Capital Repayment at M6 (Day 180)</span>
              <span class="small">% + base</span>
            </div>
            <input id="capRepPct" type="number" min="0" step="0.1" value="10" />
            <div class="row">
              <div class="toggle" aria-label="Capital repayment base">
                <label><input type="radio" name="capBase" value="invoice" checked /> % of Invoice</label>
                <label><input type="radio" name="capBase" value="outstanding" /> % of Outstanding</label>
              </div>
            </div>
          </div>

          <div class="field">
            <div class="label">
              <span>Additional Curtailment (Optional)</span>
              <span class="small">% + month</span>
            </div>
            <input id="addCurtPct" type="number" min="0" step="0.1" value="0" />
            <div class="row">
              <select id="addCurtMonth" aria-label="Additional curtailment month">
                <!-- populated dynamically -->
              </select>
            </div>
            <div class="note">Base matches “Capital Repayment base” toggle.</div>
          </div>
        </div>

        <div class="actions">
          <button id="recalc">Recalculate</button>
          <button class="secondary" id="reset">Reset defaults</button>
        </div>

        <div class="kpis" style="margin-top:14px;">
          <div class="kpi">
            <div class="name">Advance Amount (M0)</div>
            <div class="val" id="kpiAdvance">—</div>
          </div>
          <div class="kpi">
            <div class="name">Monthly Unit Fee</div>
            <div class="val" id="kpiUnitFee">—</div>
          </div>
          <div class="kpi">
            <div class="name">Monthly IRR</div>
            <div class="val" id="kpiIrrMo">—</div>
          </div>
          <div class="kpi">
            <div class="name">Annualized APR</div>
            <div class="val" id="kpiApr">—</div>
          </div>
        </div>

        <p class="smallPrint">
          Notes:
          <br/>• Unit fee is paid at end of each month (M1…M_sale).
          <br/>• Capital repayment at M6 occurs only if sale month ≥ 6.
          <br/>• Additional curtailment occurs in the selected month only if it is ≤ sale month.
          <br/>• Final payoff at sale month clears remaining principal.
        </p>
      </div>

      <div class="card">
        <h2>Cashflow Table</h2>
        <div class="tableWrap" id="tableWrap"></div>
        <p class="smallPrint">
          “Type” indicates whether the line is a <span class="fee">Fee</span> or <span class="cap">Capital</span> repayment/advance.
          Net row is the sum of all lines per month, used for IRR.
        </p>
      </div>
    </div>
  </div>

<script>
/* -----------------------------
   Utilities: formatting
------------------------------*/
function gbp(x){
  const sign = x < 0 ? "-" : "";
  const v = Math.abs(x);
  return sign + "£" + v.toLocaleString(undefined, {maximumFractionDigits: 2, minimumFractionDigits: 0});
}
function pct(x, decimals=2){
  if (!isFinite(x)) return "—";
  return (x*100).toFixed(decimals) + "%";
}
function clampInt(v, min, max){
  v = Math.round(Number(v));
  if (!isFinite(v)) v = min;
  return Math.max(min, Math.min(max, v));
}
function getRadio(name){
  const el = document.querySelector(`input[name="${name}"]:checked`);
  return el ? el.value : null;
}

/* -----------------------------
   IRR: monthly IRR via bisection
   Borrower cashflows: array of length N+1 for M0..MN
------------------------------*/
function npv(rate, cfs){
  let s = 0;
  for (let t=0; t<cfs.length; t++){
    s += cfs[t] / Math.pow(1+rate, t);
  }
  return s;
}
function irrMonthly(cfs){
  // Need at least one + and one - cashflow for IRR to exist
  let hasPos=false, hasNeg=false;
  for (const x of cfs){
    if (x > 0) hasPos = true;
    if (x < 0) hasNeg = true;
  }
  if (!(hasPos && hasNeg)) return NaN;

  // Bracket search
  let lo = -0.9999;
  let hi = 5.0; // 500%/mo cap
  let fLo = npv(lo, cfs);
  let fHi = npv(hi, cfs);

  // Expand hi until sign changes or cap reached
  let iter=0;
  while (fLo*fHi > 0 && hi < 100 && iter < 50){
    hi *= 2;
    fHi = npv(hi, cfs);
    iter++;
  }
  if (fLo*fHi > 0) return NaN;

  // Bisection
  for (let i=0; i<120; i++){
    const mid = (lo+hi)/2;
    const fMid = npv(mid, cfs);
    if (Math.abs(fMid) < 1e-8) return mid;
    if (fLo*fMid <= 0){
      hi = mid;
      fHi = fMid;
    }else{
      lo = mid;
      fLo = fMid;
    }
  }
  return (lo+hi)/2;
}

/* -----------------------------
   Model builder
------------------------------*/
function buildModel(){
  const invoice = Math.max(0, Number(document.getElementById("invoice").value) || 0);
  const advancePct = Math.max(0, Number(document.getElementById("advancePct").value) || 0) / 100;
  const saleMonth = clampInt(document.getElementById("saleMonth").value, 1, 120);

  const procFee = Math.max(0, Number(document.getElementById("procFee").value) || 0);

  const unitFeePctMo = Math.max(0, Number(document.getElementById("unitFeePct").value) || 0) / 100;
  const unitBase = getRadio("unitBase"); // invoice or advance

  const capRepPct = Math.max(0, Number(document.getElementById("capRepPct").value) || 0) / 100;
  const capBase = getRadio("capBase"); // invoice or outstanding (and shared with add curtailment)

  const addCurtPct = Math.max(0, Number(document.getElementById("addCurtPct").value) || 0) / 100;
  const addCurtMonth = clampInt(document.getElementById("addCurtMonth").value, 1, 120);

  const months = saleMonth;

  const advanceAmt = invoice * advancePct;

  // Monthly unit fee base
  const unitFeeBaseAmt = (unitBase === "advance") ? advanceAmt : invoice;
  const unitFeeMonthly = unitFeeBaseAmt * unitFeePctMo;

  // Initialize lines (arrays length months+1)
  const zeros = () => Array(months+1).fill(0);

  const lineAdvance = zeros();
  const lineProcFee = zeros();
  const lineUnitFee = zeros();
  const lineCapRep = zeros();
  const lineAddCurt = zeros();
  const lineFinalPay = zeros();

  // M0
  lineAdvance[0] = advanceAmt;     // capital inflow
  lineProcFee[0] = -procFee;       // fee outflow

  // Monthly unit fee: M1..M_sale (month-end)
  for (let m=1; m<=months; m++){
    lineUnitFee[m] = -unitFeeMonthly;
  }

  // Track principal balance
  let principal = advanceAmt;

  // Helper: compute a curtailment payment amount based on selected base
  function computeCurtailAmt(pct){
    if (pct <= 0) return 0;
    if (capBase === "invoice"){
      return invoice * pct;
    }else{
      return principal * pct;
    }
  }

  // Apply scheduled capital repayment at M6 if relevant
  if (months >= 6 && capRepPct > 0){
    const pay = Math.min(principal, computeCurtailAmt(capRepPct));
    lineCapRep[6] = -pay;
    principal -= pay;
  }

  // Apply additional curtailment in chosen month (if before/at sale month and pct > 0)
  // If additional month is 6 as well, it stacks (not redundant by default because pct default is 0).
  if (addCurtPct > 0 && addCurtMonth <= months){
    // If additional month is before 6, principal hasn't been reduced by M6 yet; that's intended.
    // If after 6, it applies to post-M6 principal if base is 'outstanding'.
    // We need to simulate month-by-month principal if addCurtMonth < 6, because principal hasn't changed yet.
    // principal currently reflects after M6 payment; so we must compute properly:
    // Approach: replay principal schedule in chronological order.
    principal = advanceAmt;
    // Apply additional first/second depending on month ordering.
    const events = [];
    if (months >= 6 && capRepPct > 0) events.push({m:6, type:"cap", pct:capRepPct});
    events.push({m:addCurtMonth, type:"add", pct:addCurtPct});
    events.sort((a,b)=>a.m-b.m);

    // reset lines (except advance/proc/unit) for cap/add/final
    lineCapRep.fill(0);
    lineAddCurt.fill(0);

    for (const e of events){
      if (e.m > months) continue;
      if (e.type === "cap"){
        const amt = Math.min(principal, (capBase === "invoice") ? invoice*e.pct : principal*e.pct);
        lineCapRep[e.m] += -amt;
        principal -= amt;
      }else{
        const amt = Math.min(principal, (capBase === "invoice") ? invoice*e.pct : principal*e.pct);
        lineAddCurt[e.m] += -amt;
        principal -= amt;
      }
    }
  }

  // If addCurtPct == 0, principal is as computed after M6 (or untouched)
  // If addCurtPct > 0, principal was computed in the replay block above.
  // If addCurtPct == 0 and we did M6, principal already reduced; else still full.

  // Final payoff at sale month clears remaining principal
  lineFinalPay[months] = -principal;

  // Net cashflows
  const net = zeros();
  for (let m=0; m<=months; m++){
    net[m] =
      lineAdvance[m] +
      lineProcFee[m] +
      lineUnitFee[m] +
      lineCapRep[m] +
      lineAddCurt[m] +
      lineFinalPay[m];
  }

  const irrMo = irrMonthly(net);
  const apr = isFinite(irrMo) ? (Math.pow(1+irrMo, 12) - 1) : NaN;

  return {
    invoice, advancePct, saleMonth: months, procFee,
    unitFeePctMo, unitBase, capRepPct, capBase,
    addCurtPct, addCurtMonth,
    advanceAmt, unitFeeMonthly,
    lines: {
      advance: lineAdvance,
      procFee: lineProcFee,
      unitFee: lineUnitFee,
      capRep: lineCapRep,
      addCurt: lineAddCurt,
      finalPay: lineFinalPay,
      net
    },
    irrMo, apr
  };
}

/* -----------------------------
   Table renderer
------------------------------*/
function renderTable(model){
  const months = model.saleMonth;
  const cols = [];
  cols.push("M0");
  for (let m=1; m<=months; m++) cols.push("M"+m);

  function rowHtml(typeLabel, typeClass, name, arr, isNet=false){
    let t = `<tr>
      <td class="left ${typeClass}">${typeLabel}</td>
      <td class="left2 ${typeClass}">${name}</td>`;
    for (let i=0; i<arr.length; i++){
      const v = arr[i];
      const cls = isNet ? "net" : (v<0 ? "neg" : (v>0 ? "pos" : "muted"));
      t += `<td class="${cls}">${v===0 ? "—" : gbp(v)}</td>`;
    }
    t += `</tr>`;
    return t;
  }

  const head = `<table>
    <thead>
      <tr>
        <th class="left">Type</th>
        <th class="left2">Line Item</th>
        ${cols.map(c=>`<th>${c}</th>`).join("")}
      </tr>
    </thead>
    <tbody>`;

  const body =
      rowHtml("Capital", "cap", "Advance proceeds", model.lines.advance)
    + rowHtml("Fee", "fee", "Processing fee (M0)", model.lines.procFee)
    + rowHtml("Fee", "fee", `Unit fee (${(model.unitFeePctMo*100).toFixed(4)}%/mo on ${model.unitBase === "advance" ? "Advance" : "Invoice"})`, model.lines.unitFee)
    + rowHtml("Capital", "cap", `Capital repayment @ M6 (${(model.capRepPct*100).toFixed(2)}% of ${model.capBase === "outstanding" ? "Outstanding" : "Invoice"})`, model.lines.capRep)
    + rowHtml("Capital", "cap", `Additional curtailment @ M${model.addCurtMonth} (${(model.addCurtPct*100).toFixed(2)}% of ${model.capBase === "outstanding" ? "Outstanding" : "Invoice"})`, model.lines.addCurt)
    + rowHtml("Capital", "cap", `Final payoff @ M${months}`, model.lines.finalPay)
    + rowHtml("—", "net", "Net cashflow (IRR input)", model.lines.net, true);

  const foot = `</tbody></table>`;

  document.getElementById("tableWrap").innerHTML = head + body + foot;
}

/* -----------------------------
   Populate month dropdown
------------------------------*/
function populateCurtailmentMonthDropdown(){
  const sel = document.getElementById("addCurtMonth");
  const saleMonth = clampInt(document.getElementById("saleMonth").value, 1, 120);
  const current = Number(sel.value) || 6;
  sel.innerHTML = "";
  for (let m=1; m<=Math.max(12, saleMonth); m++){
    const opt = document.createElement("option");
    opt.value = String(m);
    opt.textContent = `Month ${m}`;
    sel.appendChild(opt);
  }
  // Default to 6 if not set
  sel.value = String(Math.min(Math.max(6, 1), Math.max(12, saleMonth)));
  // If user previously selected something, keep it if still in range
  if (current && current <= Math.max(12, saleMonth)){
    sel.value = String(current);
  }
}

/* -----------------------------
   KPI renderer
------------------------------*/
function renderKpis(model){
  document.getElementById("kpiAdvance").textContent = gbp(model.advanceAmt);
  document.getElementById("kpiUnitFee").textContent = gbp(model.unitFeeMonthly);
  document.getElementById("kpiIrrMo").textContent = isFinite(model.irrMo) ? pct(model.irrMo, 3) : "—";
  document.getElementById("kpiApr").textContent = isFinite(model.apr) ? pct(model.apr, 2) : "—";
}

/* -----------------------------
   Recalc
------------------------------*/
function recalc(){
  // ensure dropdown range covers sale month
  populateCurtailmentMonthDropdown();
  const model = buildModel();
  renderKpis(model);
  renderTable(model);
}

/* -----------------------------
   Reset defaults
------------------------------*/
function resetDefaults(){
  document.getElementById("invoice").value = 1000000;
  document.getElementById("advancePct").value = 80;
  document.getElementById("saleMonth").value = 12;
  document.getElementById("procFee").value = 250;
  document.getElementById("unitFeePct").value = 0.65;
  document.querySelector(`input[name="unitBase"][value="invoice"]`).checked = true;
  document.getElementById("capRepPct").value = 10;
  document.querySelector(`input[name="capBase"][value="invoice"]`).checked = true;
  document.getElementById("addCurtPct").value = 0;
  populateCurtailmentMonthDropdown();
  document.getElementById("addCurtMonth").value = "6";
  recalc();
}

/* -----------------------------
   Wire up events
------------------------------*/
document.getElementById("recalc").addEventListener("click", recalc);
document.getElementById("reset").addEventListener("click", resetDefaults);

// Live recalculation on input changes
[
  "invoice","advancePct","saleMonth","procFee","unitFeePct","capRepPct","addCurtPct","addCurtMonth"
].forEach(id=>{
  document.getElementById(id).addEventListener("input", ()=>{
    // Keep the add-curtailment month options aligned with sale month changes
    if (id === "saleMonth") populateCurtailmentMonthDropdown();
    recalc();
  });
});
document.querySelectorAll('input[name="unitBase"]').forEach(el=>el.addEventListener("change", recalc));
document.querySelectorAll('input[name="capBase"]').forEach(el=>el.addEventListener("change", recalc));

// init
populateCurtailmentMonthDropdown();
recalc();
</script>
</body>
</html>
